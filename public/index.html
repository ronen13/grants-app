<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>××¢× ×§×™× ×‘×§×œ×™×§</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --gold:#C8A96E; --gold-light:#E8D5A3;
  --dark:#0D1117; --card:#161B22; --border:#21262D;
  --text:#E6EDF3; --muted:#8B949E;
  --green:#3FB950; --blue:#58A6FF; --orange:#F0883E; --red:#F85149;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Heebo',sans-serif;background:var(--dark);color:var(--text);min-height:100vh;direction:rtl;}

/* â”€â”€ LOGIN â”€â”€ */
#loginScreen {
  min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 60% 40%, rgba(200,169,110,0.08) 0%, transparent 60%), var(--dark);
}
.login-box {
  background:var(--card);border:1px solid var(--border);border-radius:16px;
  padding:2.5rem 2rem;width:360px;text-align:center;
}
.login-box h1{font-size:1.6rem;font-weight:900;color:var(--gold);margin-bottom:0.3rem;}
.login-box p{color:var(--muted);font-size:0.85rem;margin-bottom:2rem;}
.login-box input {
  width:100%;background:var(--dark);border:1px solid var(--border);border-radius:8px;
  padding:0.75rem 1rem;color:var(--text);font-family:'Heebo',sans-serif;font-size:0.95rem;
  outline:none;margin-bottom:1rem;text-align:center;letter-spacing:2px;
  transition:border-color 0.2s;
}
.login-box input:focus{border-color:var(--gold);}
.login-err{color:var(--red);font-size:0.82rem;margin-top:0.5rem;min-height:1.2rem;}

/* â”€â”€ APP â”€â”€ */
#app{display:none;}
.layout{display:flex;height:100vh;overflow:hidden;}

/* SIDEBAR */
.sidebar{width:255px;background:var(--card);border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;}
.sidebar-logo{padding:1.4rem 1.2rem 1rem;border-bottom:1px solid var(--border);}
.sidebar-logo h1{font-size:1.05rem;font-weight:900;color:var(--gold);}
.sidebar-logo p{font-size:0.7rem;color:var(--muted);margin-top:0.15rem;}
.sidebar-section{padding:0.8rem 1rem 0.3rem;font-size:0.62rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--muted);}
.client-list{flex:1;overflow-y:auto;padding:0.3rem 0.5rem;}
.client-item{
  display:flex;align-items:center;gap:0.6rem;
  padding:0.6rem 0.75rem;border-radius:7px;cursor:pointer;
  transition:all 0.15s;margin-bottom:2px;border:1px solid transparent;
}
.client-item:hover{background:rgba(200,169,110,0.06);}
.client-item.active{background:rgba(200,169,110,0.1);border-color:rgba(200,169,110,0.25);}
.client-avatar{
  width:30px;height:30px;border-radius:7px;
  background:linear-gradient(135deg,var(--gold),var(--gold-light));
  display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:0.75rem;color:#1a1a1a;flex-shrink:0;
}
.client-meta{flex:1;min-width:0;}
.client-meta-name{font-size:0.82rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.client-meta-sub{font-size:0.68rem;color:var(--muted);}
.client-del{opacity:0;background:none;border:none;color:var(--red);cursor:pointer;font-size:0.85rem;padding:2px 5px;border-radius:4px;transition:all 0.15s;}
.client-item:hover .client-del{opacity:1;}
.sidebar-footer{padding:0.7rem;border-top:1px solid var(--border);}
.btn-new{width:100%;padding:0.65rem;border-radius:7px;background:rgba(200,169,110,0.1);border:1px dashed rgba(200,169,110,0.3);color:var(--gold);font-family:'Heebo',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.2s;}
.btn-new:hover{background:rgba(200,169,110,0.2);}

/* MAIN */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column;}
.topbar{background:var(--card);border-bottom:1px solid var(--border);padding:0.9rem 1.8rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;flex-shrink:0;}
.topbar-title{font-size:1rem;font-weight:700;}
.topbar-sub{font-size:0.75rem;color:var(--muted);margin-top:0.1rem;}
.btn-row{display:flex;gap:0.5rem;flex-wrap:wrap;}

.btn{display:inline-flex;align-items:center;gap:0.3rem;padding:0.45rem 1rem;border-radius:7px;border:none;font-family:'Heebo',sans-serif;font-size:0.8rem;font-weight:600;cursor:pointer;transition:all 0.18s;white-space:nowrap;}
.btn:disabled{opacity:0.5;cursor:not-allowed;}
.btn-gold{background:var(--gold);color:#0D1117;}
.btn-gold:hover:not(:disabled){background:var(--gold-light);}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted);}
.btn-outline:hover{border-color:var(--gold);color:var(--gold);}
.btn-green{background:rgba(63,185,80,0.12);border:1px solid rgba(63,185,80,0.3);color:var(--green);}
.btn-green:hover{background:rgba(63,185,80,0.22);}
.btn-blue{background:rgba(88,166,255,0.12);border:1px solid rgba(88,166,255,0.3);color:var(--blue);}
.btn-wa{background:rgba(37,211,102,0.1);border:1px solid rgba(37,211,102,0.3);color:#25D366;}
.btn-red-sm{background:none;border:1px solid var(--border);color:var(--muted);font-size:0.75rem;}
.btn-red-sm:hover{border-color:var(--red);color:var(--red);}

.content{padding:1.5rem 1.8rem;flex:1;}

/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;gap:0.8rem;text-align:center;}
.empty-icon{font-size:2.8rem;}
.empty h2{font-size:1.2rem;font-weight:700;}
.empty p{color:var(--muted);font-size:0.88rem;}

/* SHARE PANEL */
.share-panel{background:rgba(200,169,110,0.06);border:1px solid rgba(200,169,110,0.18);border-radius:10px;padding:1.1rem 1.3rem;margin-bottom:1.3rem;}
.share-panel-title{font-size:0.78rem;font-weight:700;color:var(--gold);margin-bottom:0.8rem;text-transform:uppercase;letter-spacing:0.8px;}
.share-row{display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;}
.url-box{display:flex;align-items:center;gap:0.5rem;background:var(--dark);border:1px solid var(--border);border-radius:7px;padding:0.4rem 0.7rem;flex:1;min-width:220px;}
.url-box input{background:none;border:none;color:var(--muted);font-size:0.76rem;flex:1;outline:none;font-family:monospace;}
.url-copy{background:none;border:none;color:var(--gold);cursor:pointer;font-size:0.76rem;font-weight:700;padding:0.2rem 0.4rem;border-radius:4px;font-family:'Heebo',sans-serif;white-space:nowrap;}

/* SECTION CARD */
.sc{background:var(--card);border:1px solid var(--border);border-radius:10px;margin-bottom:1.3rem;}
.sc-head{padding:0.9rem 1.3rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:0.5rem;}
.sc-head h3{font-size:0.88rem;font-weight:700;display:flex;align-items:center;gap:0.5rem;}
.sc-body{padding:1.2rem 1.3rem;}
.form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.9rem;}
.field label{display:block;font-size:0.67rem;text-transform:uppercase;letter-spacing:0.7px;color:var(--muted);margin-bottom:0.35rem;font-weight:600;}
.field input,.field textarea,.field select{width:100%;background:var(--dark);border:1px solid var(--border);border-radius:7px;padding:0.55rem 0.8rem;color:var(--text);font-family:'Heebo',sans-serif;font-size:0.86rem;outline:none;transition:border-color 0.2s;}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--gold);}
.field textarea{resize:vertical;min-height:65px;line-height:1.5;}
select option{background:#161B22;}
.field-wide{grid-column:1/-1;}

/* TABLE */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;min-width:860px;}
thead tr{background:rgba(255,255,255,0.02);}
th{padding:0.7rem 0.85rem;text-align:right;font-size:0.65rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.7px;border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid rgba(33,38,45,0.5);transition:background 0.12s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:rgba(200,169,110,0.025);}
td{padding:0.5rem 0.85rem;vertical-align:middle;}
.ci{background:transparent;border:1px solid transparent;border-radius:5px;padding:0.28rem 0.4rem;color:var(--text);font-family:'Heebo',sans-serif;font-size:0.82rem;width:100%;outline:none;transition:all 0.18s;}
.ci:focus{background:rgba(200,169,110,0.05);border-color:var(--gold);}
.cs{background:var(--dark);border:1px solid transparent;border-radius:5px;padding:0.28rem 0.4rem;color:var(--text);font-family:'Heebo',sans-serif;font-size:0.78rem;width:100%;outline:none;cursor:pointer;}
.cs:focus{border-color:var(--gold);}
.rng{display:flex;align-items:center;gap:5px;}
.rng input[type=range]{width:60px;accent-color:var(--gold);}
.rng-val{font-size:0.75rem;color:var(--gold);min-width:30px;font-weight:700;}
.del-row{background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.9rem;padding:0.2rem 0.4rem;border-radius:4px;transition:all 0.15s;}
.del-row:hover{color:var(--red);background:rgba(248,81,73,0.1);}
.add-row{width:100%;padding:0.8rem;background:none;border:none;border-top:1px dashed var(--border);color:var(--muted);font-size:0.82rem;cursor:pointer;font-family:'Heebo',sans-serif;display:flex;align-items:center;justify-content:center;gap:0.5rem;transition:all 0.18s;}
.add-row:hover{color:var(--gold);background:rgba(200,169,110,0.03);}

/* SAVING INDICATOR */
.saving{font-size:0.75rem;color:var(--muted);display:flex;align-items:center;gap:0.4rem;}
.saving.active{color:var(--orange);}
.saving.done{color:var(--green);}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.72);z-index:1000;align-items:center;justify-content:center;}
.overlay.open{display:flex;}
.modal{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:2rem;width:420px;max-width:92vw;}
.modal h2{font-size:1rem;font-weight:700;margin-bottom:0.35rem;}
.modal p{color:var(--muted);font-size:0.83rem;margin-bottom:1.4rem;}
.modal-fields{display:flex;flex-direction:column;gap:0.75rem;}
.modal-btns{display:flex;gap:0.6rem;justify-content:flex-end;margin-top:1.4rem;}

/* TOAST */
.toast{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(80px);background:#1e2330;border:1px solid var(--border);border-radius:8px;padding:0.65rem 1.2rem;font-size:0.84rem;transition:transform 0.3s;z-index:2000;white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}

/* CLIENT PAGE STYLES (injected into iframe/new window) */
</style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€ -->
<div id="loginScreen">
  <div class="login-box">
    <h1>××¢× ×§×™× ×‘×§×œ×™×§ âœ¦</h1>
    <p>××¢×¨×›×ª × ×™×”×•×œ ×œ×§×•×—×•×ª â€“ ×›× ×™×¡×” ×××•×‘×˜×—×ª</p>
    <input type="password" id="passInput" placeholder="×¡×™×¡××”" onkeydown="if(event.key==='Enter')login()">
    <button class="btn btn-gold" style="width:100%;padding:0.75rem;font-size:0.95rem;" onclick="login()">×›× ×™×¡×”</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<!-- â”€â”€ APP â”€â”€ -->
<div id="app">
  <div class="layout">

    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-logo">
        <h1>××¢× ×§×™× ×‘×§×œ×™×§ âœ¦</h1>
        <p>××¢×¨×›×ª × ×™×”×•×œ ×œ×§×•×—×•×ª</p>
      </div>
      <div class="sidebar-section">×œ×§×•×—×•×ª</div>
      <div class="client-list" id="clientList"></div>
      <div class="sidebar-footer">
        <button class="btn-new" onclick="openNewModal()">ï¼‹ ×œ×§×•×— ×—×“×©</button>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <div class="topbar">
        <div>
          <div class="topbar-title" id="topTitle">×‘×—×¨ ×œ×§×•×—</div>
          <div class="topbar-sub" id="topSub">×‘×—×¨ ×œ×§×•×— ××”×¨×©×™××” ××• ×¦×•×¨ ×—×“×©</div>
        </div>
        <div style="display:flex;align-items:center;gap:0.8rem;">
          <div class="saving" id="saveInd"><div class="dot"></div><span id="saveText">×©××•×¨</span></div>
          <div class="btn-row" id="topBtns" style="display:none;">
            <button class="btn btn-outline" onclick="previewClient()">ğŸ‘ ×ª×¦×•×’×” ××§×“×™××”</button>
            <button class="btn btn-wa" onclick="sendWA()">ğŸ’¬ WhatsApp</button>
            <button class="btn btn-blue" onclick="sendEmail()">âœ‰ï¸ ××™×™×œ</button>
            <button class="btn btn-outline" onclick="printPDF()">ğŸ“„ PDF</button>
            <button class="btn btn-gold" onclick="copyLink()">ğŸ”— ×œ×™× ×§</button>
          </div>
        </div>
      </div>
      <div class="content" id="mainContent">
        <div class="empty">
          <div class="empty-icon">ğŸ“‹</div>
          <h2>××™×Ÿ ×œ×§×•×— × ×‘×—×¨</h2>
          <p>×‘×—×¨ ×œ×§×•×— ××”×¨×©×™××” ××• ×œ×—×¥ "×œ×§×•×— ×—×“×©"</p>
          <button class="btn btn-gold" style="margin-top:0.5rem" onclick="openNewModal()">ï¼‹ ×œ×§×•×— ×—×“×©</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- NEW CLIENT MODAL -->
<div class="overlay" id="newModal">
  <div class="modal">
    <h2>×œ×§×•×— ×—×“×©</h2>
    <p>×”×–×Ÿ ×¤×¨×˜×™× ×‘×¡×™×¡×™×™× â€” × ×™×ª×Ÿ ×œ×¢×¨×•×š ×”×›×œ ××—×¨ ×›×š</p>
    <div class="modal-fields">
      <div class="field"><label>×©× ×”×—×‘×¨×” / ×”×œ×§×•×— *</label><input id="nc_name" placeholder="×—×‘×¨×ª ××œ×¤× ×‘×¢×´×"></div>
      <div class="field"><label>×©× ××™×© ×§×©×¨</label><input id="nc_contact" placeholder="×“× ×™××œ ×›×”×Ÿ"></div>
      <div class="field"><label>×ª×—×•× ×¢×¡×§×™</label><input id="nc_sector" placeholder="×˜×›× ×•×œ×•×’×™×”, ×™×™×¦×•×..."></div>
      <div class="field"><label>××™×™×œ</label><input id="nc_email" type="email" placeholder="client@company.com"></div>
      <div class="field"><label>×˜×œ×¤×•×Ÿ / WhatsApp</label><input id="nc_phone" placeholder="052-0000000"></div>
    </div>
    <div class="modal-btns">
      <button class="btn btn-outline" onclick="closeModal('newModal')">×‘×™×˜×•×œ</button>
      <button class="btn btn-gold" onclick="createClient()">×¦×•×¨ ×œ×§×•×—</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ADMIN_KEY = '';
let clients = [];        // full list from server
let activeId = null;     // currently selected client id
let saveTimer = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function login() {
  const pass = document.getElementById('passInput').value;
  const err = document.getElementById('loginErr');
  if (!pass) { err.textContent = '×”×›× ×¡ ×¡×™×¡××”'; return; }

  // Test the password against the API
  try {
    const r = await apiFetch('/api/clients', 'GET', null, pass);
    if (r.ok) {
      ADMIN_KEY = pass;
      clients = await r.json();
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      renderSidebar();
      // Check if URL has a hash for direct client view
      checkHash();
    } else {
      err.textContent = '×¡×™×¡××” ×©×’×•×™×”';
    }
  } catch(e) {
    err.textContent = '×©×’×™××ª ×—×™×‘×•×¨ ×œ×©×¨×ª';
  }
}

document.getElementById('passInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') login();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function apiFetch(path, method='GET', body=null, key=null) {
  const headers = { 'Content-Type': 'application/json', 'x-admin-key': key || ADMIN_KEY };
  return fetch(path, { method, headers, body: body ? JSON.stringify(body) : null });
}

async function apiJSON(path, method='GET', body=null) {
  const r = await apiFetch(path, method, body);
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  const el = document.getElementById('clientList');
  if (!clients.length) {
    el.innerHTML = `<div style="padding:1rem 0.8rem;color:var(--muted);font-size:0.78rem;text-align:center;">××™×Ÿ ×œ×§×•×—×•×ª ×¢×“×™×™×Ÿ</div>`;
    return;
  }
  el.innerHTML = clients.map(c => {
    const initials = c.name.split(' ').map(w=>w[0]).join('').substr(0,2).toUpperCase();
    const gc = (c.grants||[]).length;
    return `
      <div class="client-item${c.id===activeId?' active':''}" onclick="selectClient('${c.id}')">
        <div class="client-avatar">${initials}</div>
        <div class="client-meta">
          <div class="client-meta-name">${c.name}</div>
          <div class="client-meta-sub">${gc} ××¢× ×§×™×${c.sector?' Â· '+c.sector:''}</div>
        </div>
        <button class="client-del" onclick="deleteClient('${c.id}',event)">âœ•</button>
      </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLIENT CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNewModal() { openOverlay('newModal'); }

async function createClient() {
  const name = document.getElementById('nc_name').value.trim();
  if (!name) { toast('×—×•×‘×” ×œ×”×–×™×Ÿ ×©× ×œ×§×•×—','âš ï¸'); return; }
  try {
    const res = await apiJSON('/api/clients', 'POST', {
      name,
      contact: document.getElementById('nc_contact').value.trim(),
      sector:  document.getElementById('nc_sector').value.trim(),
      email:   document.getElementById('nc_email').value.trim(),
      phone:   document.getElementById('nc_phone').value.trim(),
    });
    await refreshClients();
    selectClient(res.id);
    closeModal('newModal');
    toast('×œ×§×•×— × ×•×¦×¨!','âœ…');
  } catch(e) { toast('×©×’×™××” ×‘×™×¦×™×¨×ª ×œ×§×•×—','âŒ'); }
}

async function deleteClient(id, e) {
  e.stopPropagation();
  if (!confirm('×œ××—×•×§ ×œ×§×•×— ×–×” ×œ×¦××™×ª×•×ª?')) return;
  await apiJSON(`/api/clients/${id}`, 'DELETE');
  if (activeId === id) { activeId = null; showEmpty(); }
  await refreshClients();
  toast('×œ×§×•×— × ××—×§','ğŸ—‘');
}

async function refreshClients() {
  clients = await apiJSON('/api/clients');
  renderSidebar();
}

function activeClient() { return clients.find(c=>c.id===activeId); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELECT CLIENT â†’ RENDER EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function selectClient(id) {
  activeId = id;
  renderSidebar();
  const c = activeClient();
  if (!c) return;
  document.getElementById('topTitle').textContent = c.name;
  updateTopSub();
  document.getElementById('topBtns').style.display = 'flex';
  renderEditor(c);
}

function updateTopSub() {
  const c = activeClient();
  if (!c) return;
  document.getElementById('topSub').textContent =
    `${c.sector||''}${c.contact?' Â· '+c.contact:''} Â· ${(c.grants||[]).length} ××¢× ×§×™×`;
}

function showEmpty() {
  document.getElementById('topTitle').textContent = '×‘×—×¨ ×œ×§×•×—';
  document.getElementById('topSub').textContent = '';
  document.getElementById('topBtns').style.display = 'none';
  document.getElementById('mainContent').innerHTML = `
    <div class="empty">
      <div class="empty-icon">ğŸ“‹</div>
      <h2>××™×Ÿ ×œ×§×•×— × ×‘×—×¨</h2>
      <p>×‘×—×¨ ×œ×§×•×— ××”×¨×©×™××” ××• ×œ×—×¥ "×œ×§×•×— ×—×“×©"</p>
      <button class="btn btn-gold" style="margin-top:0.5rem" onclick="openNewModal()">ï¼‹ ×œ×§×•×— ×—×“×©</button>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEditor(c) {
  const url = `${window.location.origin}/client/${c.id}`;
  document.getElementById('mainContent').innerHTML = `

    <div class="share-panel">
      <div class="share-panel-title">ğŸ“¤ ×©×™×ª×•×£ ×¢× ×”×œ×§×•×—</div>
      <div class="share-row">
        <div class="url-box">
          <input id="clientURL" value="${url}" readonly>
          <button class="url-copy" onclick="copyLink()">×”×¢×ª×§</button>
        </div>
        <button class="btn btn-wa" onclick="sendWA()">ğŸ’¬ WhatsApp</button>
        <button class="btn btn-blue" onclick="sendEmail()">âœ‰ï¸ ××™×™×œ</button>
        <button class="btn btn-outline" onclick="printPDF()">ğŸ“„ PDF</button>
        <button class="btn btn-outline" onclick="previewClient()">ğŸ‘ ×ª×¦×•×’×” ××§×“×™××”</button>
      </div>
    </div>

    <div class="sc">
      <div class="sc-head"><h3>ğŸ‘¤ ×¤×¨×˜×™ ×œ×§×•×—</h3></div>
      <div class="sc-body">
        <div class="form-grid">
          <div class="field"><label>×©× ×”×—×‘×¨×”</label><input value="${esc(c.name)}" oninput="patchClient('name',this.value)"></div>
          <div class="field"><label>××™×© ×§×©×¨</label><input value="${esc(c.contact||'')}" oninput="patchClient('contact',this.value)" placeholder="×©× ××œ×"></div>
          <div class="field"><label>×ª×—×•× ×¢×¡×§×™</label><input value="${esc(c.sector||'')}" oninput="patchClient('sector',this.value)" placeholder="×˜×›× ×•×œ×•×’×™×”..."></div>
          <div class="field"><label>××™×™×œ</label><input type="email" value="${esc(c.email||'')}" oninput="patchClient('email',this.value)" placeholder="client@co.com"></div>
          <div class="field"><label>×˜×œ×¤×•×Ÿ / WhatsApp</label><input value="${esc(c.phone||'')}" oninput="patchClient('phone',this.value)" placeholder="052-0000000"></div>
          <div class="field"><label>×©× ×”××¦×™×’</label><input value="${esc(c.presenter||'××¢× ×§×™× ×‘×§×œ×™×§')}" oninput="patchClient('presenter',this.value)"></div>
          <div class="field field-wide"><label>×”×•×“×¢×” ××™×©×™×ª ×œ×œ×§×•×—</label>
            <textarea oninput="patchClient('message',this.value)" placeholder="×©×œ×•× ×“× ×™××œ, ×œ××—×¨ ×‘×—×™× ×ª ×¤×¨×•×¤×™×œ ×”×—×‘×¨×” ×©×œ×š...">${esc(c.message||'')}</textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="sc">
      <div class="sc-head">
        <h3>ğŸ“‹ ××¢× ×§×™× <span style="font-size:0.72rem;font-weight:400;color:var(--muted);background:var(--dark);padding:0.15rem 0.5rem;border-radius:50px;border:1px solid var(--border);">${(c.grants||[]).length}</span></h3>
        <button class="btn btn-green" onclick="addGrant()">ï¼‹ ×”×•×¡×£ ××¢× ×§</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>#</th><th>×©× ×”××¢× ×§</th><th>×’×•×£ ××××Ÿ</th><th>×§×˜×’×•×¨×™×”</th>
            <th>×¡×›×•×</th><th>×›×™×¡×•×™</th><th>×“×“×œ×™×™×Ÿ</th><th>×¡×˜×˜×•×¡</th>
            <th>×”×ª×××”</th><th>×”×¢×¨×•×ª ×¤× ×™××™×•×ª</th><th></th>
          </tr></thead>
          <tbody id="grantsBody"></tbody>
        </table>
        <button class="add-row" onclick="addGrant()">ï¼‹ ×”×•×¡×£ ××¢× ×§ ×—×“×©</button>
      </div>
    </div>
  `;
  renderGrantsTable();
}

function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-SAVE WITH DEBOUNCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSaving(state) {
  const el = document.getElementById('saveInd');
  const txt = document.getElementById('saveText');
  el.className = 'saving' + (state==='saving'?' active': state==='done'?' done':'');
  txt.textContent = state==='saving'?'×©×•××¨...' : state==='done'?'× ×©××¨ âœ“' : '';
}

function patchClient(field, val) {
  const c = activeClient();
  if (!c) return;
  c[field] = val;
  if (field==='name') { document.getElementById('topTitle').textContent = val; renderSidebar(); }
  scheduleSave();
}

function scheduleSave() {
  setSaving('saving');
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveClient, 900);
}

async function saveClient() {
  const c = activeClient();
  if (!c) return;
  try {
    await apiJSON(`/api/clients/${c.id}`, 'PUT', c);
    // Save grants too
    await apiJSON(`/api/clients/${c.id}/grants`, 'PUT', { grants: (c.grants||[]) });
    setSaving('done');
    setTimeout(()=>setSaving('idle'), 2000);
    updateTopSub();
  } catch(e) { setSaving('idle'); toast('×©×’×™××” ×‘×©××™×¨×”','âŒ'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRANTS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGrantsTable() {
  const c = activeClient();
  const grants = c?.grants || [];
  const tbody = document.getElementById('grantsBody');
  if (!tbody) return;

  if (!grants.length) {
    tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;padding:1.8rem;color:var(--muted);font-size:0.83rem;">××™×Ÿ ××¢× ×§×™× â€” ×œ×—×¥ "×”×•×¡×£ ××¢× ×§"</td></tr>`;
    return;
  }
  tbody.innerHTML = '';
  grants.forEach((g, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="color:var(--muted);font-size:0.72rem;">${String(i+1).padStart(2,'0')}</td>
      <td><input class="ci" style="min-width:155px" value="${esc(g.name)}" oninput="updateGrant(${i},'name',this.value)" placeholder="×©× ×”××¢× ×§"></td>
      <td><input class="ci" style="min-width:120px" value="${esc(g.org)}" oninput="updateGrant(${i},'org',this.value)" placeholder="×’×•×£ ××××Ÿ"></td>
      <td><input class="ci" style="min-width:90px" value="${esc(g.cat)}" oninput="updateGrant(${i},'cat',this.value)" placeholder="×§×˜×’×•×¨×™×”"></td>
      <td><input class="ci" style="min-width:85px" value="${esc(g.amount)}" oninput="updateGrant(${i},'amount',this.value)" placeholder="â‚ª000,000"></td>
      <td><input class="ci" style="min-width:65px" value="${esc(g.cover)}" oninput="updateGrant(${i},'cover',this.value)" placeholder="50%"></td>
      <td><input class="ci" style="min-width:88px" value="${esc(g.deadline)}" oninput="updateGrant(${i},'deadline',this.value)" placeholder="DD.MM.YYYY"></td>
      <td>
        <select class="cs" onchange="updateGrant(${i},'status',this.value)">
          <option value="open" ${g.status==='open'?'selected':''}>×¤×ª×•×—</option>
          <option value="soon" ${g.status==='soon'?'selected':''}>×¢×•××“ ×œ×¤×•×’</option>
          <option value="review" ${g.status==='review'?'selected':''}>×‘×‘×“×™×§×”</option>
          <option value="closed" ${g.status==='closed'?'selected':''}>×¡×’×•×¨</option>
        </select>
      </td>
      <td>
        <div class="rng">
          <input type="range" min="0" max="100" value="${g.match_pct||70}"
            oninput="updateGrant(${i},'match_pct',parseInt(this.value));this.nextElementSibling.textContent=this.value+'%'">
          <span class="rng-val">${g.match_pct||70}%</span>
        </div>
      </td>
      <td><input class="ci" style="min-width:120px" value="${esc(g.notes)}" oninput="updateGrant(${i},'notes',this.value)" placeholder="×”×¢×¨×•×ª (×œ× ×™×•×¦×’×• ×œ×œ×§×•×—)"></td>
      <td><button class="del-row" onclick="deleteGrant(${i})">âœ•</button></td>`;
    tbody.appendChild(tr);
  });
}

function updateGrant(i, field, val) {
  const c = activeClient();
  if (!c) return;
  c.grants[i][field] = val;
  scheduleSave();
}

function addGrant() {
  const c = activeClient();
  if (!c) return;
  if (!c.grants) c.grants = [];
  c.grants.push({name:'',org:'',cat:'',amount:'',cover:'',deadline:'',status:'open',match_pct:70,notes:''});
  renderGrantsTable();
  // Update count badge
  const badge = document.querySelector('#mainContent .sc-head span');
  if (badge) badge.textContent = c.grants.length;
  // focus last
  const inputs = document.querySelectorAll('#grantsBody tr:last-child .ci');
  if (inputs[0]) inputs[0].focus();
  scheduleSave();
}

function deleteGrant(i) {
  const c = activeClient();
  if (!c) return;
  c.grants.splice(i, 1);
  renderGrantsTable();
  scheduleSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getClientURL() {
  const c = activeClient();
  return c ? `${window.location.origin}/client/${c.id}` : '';
}

function copyLink() {
  const url = getClientURL();
  if (!url) return;
  navigator.clipboard.writeText(url).then(() => toast('×œ×™× ×§ ×”×•×¢×ª×§! ğŸ‰','ğŸ”—'));
}

function sendWA() {
  const c = activeClient();
  if (!c) return;
  const url = getClientURL();
  const name = c.contact ? c.contact.split(' ')[0] : c.name;
  const msg = encodeURIComponent(`×©×œ×•× ${name}! ğŸ‘‹\n\n×¨×™×›×–× ×• ×¢×‘×•×¨×š ×“×•×— ××¢× ×§×™× ××•×ª×× ××™×©×™×ª:\n${url}\n\nâ€“ ${c.presenter||'××¢× ×§×™× ×‘×§×œ×™×§'}`);
  const phone = (c.phone||'').replace(/\D/g,'');
  window.open(phone ? `https://wa.me/972${phone.replace(/^0/,'')}?text=${msg}` : `https://wa.me/?text=${msg}`, '_blank');
}

function sendEmail() {
  const c = activeClient();
  if (!c) return;
  const url = getClientURL();
  const name = c.contact ? c.contact.split(' ')[0] : c.name;
  const subj = encodeURIComponent(`×“×•×— ××¢× ×§×™× â€“ ${c.name}`);
  const body = encodeURIComponent(`×©×œ×•× ${name},\n\n×¨×™×›×–× ×• ${(c.grants||[]).length} ××¢× ×§×™× ×¨×œ×•×•× ×˜×™×™× ×œ×¢×¡×§ ×©×œ×š.\n\n×œ×¦×¤×™×™×” ×‘×“×•×—:\n${url}\n\n×‘×‘×¨×›×”,\n${c.presenter||'××¢× ×§×™× ×‘×§×œ×™×§'}`);
  window.open(`mailto:${c.email||''}?subject=${subj}&body=${body}`);
}

function previewClient() {
  const url = getClientURL();
  if (url) window.open(url, '_blank');
}

function printPDF() {
  const url = getClientURL();
  if (url) {
    const w = window.open(url + '?print=1', '_blank');
    setTimeout(() => w?.print(), 1200);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HASH / CLIENT VIEW ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkHash() {
  // handled by server routing â€” /client/:id returns client page
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openOverlay(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

function toast(msg, icon='â„¹ï¸') {
  const t = document.getElementById('toast');
  t.textContent = icon+' '+msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 3000);
}

document.querySelectorAll('.overlay').forEach(el =>
  el.addEventListener('click', e => { if(e.target===el) el.classList.remove('open'); })
);
</script>
</body>
</html>
